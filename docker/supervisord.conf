[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/app/logs
user=appuser

[program:uvicorn]
command=/opt/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4 --loop asyncio --log-level info
directory=/app
user=appuser
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
stopsignal=INT
stdout_logfile=/app/logs/uvicorn-out.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/app/logs/uvicorn-err.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}",
    REDIS_URL="redis://${REDIS_HOST}:${REDIS_PORT}/0",
    SECRET_KEY="${SECRET_KEY}"

[program:celery-worker]
command=/opt/venv/bin/celery -A tasks worker --loglevel=info --concurrency=4
directory=/app
user=appuser
autostart=true
autorestart=true
stdout_logfile=/app/logs/celery-worker.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/app/logs/celery-worker-err.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}",
    REDIS_URL="redis://${REDIS_HOST}:${REDIS_PORT}/0"

[program:celery-beat]
command=/opt/venv/bin/celery -A tasks beat --loglevel=info
directory=/app
user=appuser
autostart=true
autorestart=true
stdout_logfile=/app/logs/celery-beat.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/app/logs/celery-beat-err.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-err.log

[group:telemedicina]
programs=uvicorn,celery-worker,celery-beat,nginx
priority=999